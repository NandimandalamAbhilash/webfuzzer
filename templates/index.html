<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>WebFuzzer — Security Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Load Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Load Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <style>
    /* Custom Configuration for Colors and Fonts */
    :root {
      /* Primary Brand Color: Teal */
      --color-primary: #0d9488;
      /* Accent/Focus Color: Cyan */
      --color-accent: #06b6d4;
      /* Backgrounds */
      --bg-light: #f3f4f6;
      /* Status Colors */
      --status-safe: #10b981;
      --status-not-safe: #ef4444;
      --status-warning: #f59e0b;
    }
    
    body {
      font-family: "Inter", sans-serif;
      background: var(--bg-light);
    }
    
    .card-design {
      border-radius: 1rem; /* Large rounded corners */
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.04), 0 2px 6px rgba(0, 0, 0, 0.04);
      transition: all 0.3s ease;
    }

    /* Status classes for JS rendering */
    .status-200 { color: var(--status-safe); font-weight: 600; }
    .status-403 { color: var(--status-warning); font-weight: 600; }
    .status-other { color: var(--status-not-safe); font-weight: 600; }
    
    /* Verdict badges */
    .verdict-safe { background: #d1fae5; color: #065f46; } /* Green */
    .verdict-not { background: #fee2e2; color: #991b1b; } /* Red */
    .verdict-pending { background: #e0f2f1; color: #14532d; } /* Light Teal/Green */

    /* Monospace for security data (URL/Payloads) */
    .monospace {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
      word-break: break-all;
      font-size: 0.8rem;
    }
  </style>
</head>
<body class="min-h-screen">
  <div class="container mx-auto p-4 sm:p-6 lg:p-8">
    
    <!-- Header -->
    <header class="mb-8 flex justify-between items-center bg-white p-4 rounded-xl shadow-md">
        <h1 class="text-3xl font-extrabold text-gray-900 flex items-center">
            <i data-lucide="shield-check" class="w-8 h-8 mr-2 text-teal-600"></i> WebFuzzer
            <span class="text-base font-medium text-gray-500 ml-2">— Control Panel</span>
        </h1>
        <a class="text-sm font-medium text-teal-600 hover:text-teal-800 transition flex items-center" href="/history">
            <i data-lucide="history" class="w-5 h-5 inline mr-1"></i> Full History
        </a>
    </header>

    <!-- 1. Scan Creation Card (Form) -->
    <div class="bg-white p-6 card-design mb-8 border-t-4 border-teal-500">
      <h2 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center">
        <i data-lucide="cpu" class="w-5 h-5 mr-3 text-teal-600"></i> Configure New Scan
      </h2>
      <form id="jobForm" class="space-y-8">
        
        <!-- Target & Modes Group -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-6">
          
          <!-- Target Input (Spans 3 columns on desktop) -->
          <div class="md:col-span-3">
            <label for="target" class="block text-sm font-bold text-gray-700 mb-1">Target URL</label>
            <input id="target" class="block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-teal-500 focus:border-teal-500 transition" 
                   placeholder="https://secure.example.com (include scheme)" required>
            <p class="mt-1 text-xs text-gray-500">The base URL for the fuzzing operation.</p>
          </div>

          <!-- Fuzzing Modes (Spans 2 columns on desktop) -->
          <div class="md:col-span-2">
            <label class="block text-sm font-bold text-gray-700 mb-2">Fuzzing Modes (Select one or more)</label>
            <div id="modesContainer" class="grid grid-cols-2 gap-x-4 gap-y-2 p-3 bg-teal-50 border border-teal-200 rounded-lg">
              
              <div class="flex items-center">
                <input class="h-4 w-4 text-teal-600 border-gray-300 rounded" type="checkbox" value="dirs" id="modeDirs">
                <label class="ml-2 text-sm text-gray-900 font-medium" for="modeDirs">Directories & Files</label>
              </div>
              
              <div class="flex items-center">
                <input class="h-4 w-4 text-teal-600 border-gray-300 rounded" type="checkbox" value="params" id="modeParams">
                <label class="ml-2 text-sm text-gray-900 font-medium" for="modeParams">Parameters (Injection)</label>
              </div>
              
              <div class="flex items-center">
                <input class="h-4 w-4 text-teal-600 border-gray-300 rounded" type="checkbox" value="vhosts" id="modeVhosts">
                <label class="ml-2 text-sm text-gray-900 font-medium" for="modeVhosts">Virtual Hosts</label>
              </div>
              
              <div class="flex items-center opacity-50 cursor-not-allowed">
                <input class="h-4 w-4 text-gray-400 border-gray-300 rounded" type="checkbox" value="apis" id="modeApis" disabled>
                <label class="ml-2 text-sm text-gray-500" for="modeApis">API Endpoints (Future)</label>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Customization Group -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4 border-t border-gray-100">
            
            <!-- Optional Parameter Names -->
            <div>
              <label for="paramsInput" class="block text-sm font-bold text-gray-700 mb-1">Optional Parameter Names</label>
              <input id="paramsInput" class="block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-teal-500 focus:border-teal-500 transition" 
                     placeholder="id, page, user_id, q">
              <p class="mt-1 text-xs text-gray-500">Comma-separated list of parameter names to test. Used with "Parameters" mode.</p>
            </div>

            <!-- Wordlist/Payload Uploads -->
            <div class="space-y-2">
              <label class="block text-sm font-bold text-gray-700">Custom Wordlists (Optional)</label>
              <input id="wordlistFile" type="file" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100 transition duration-150" accept=".txt" />
              <input id="payloadFile" type="file" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100 transition duration-150" accept=".txt" />
            </div>
        </div>

        <!-- Action Row & Status Message -->
        <div class="flex flex-col sm:flex-row justify-between items-start pt-6 border-t border-gray-200 mt-6">
          <div id="jobMessage" class="text-sm text-gray-600 mb-3 sm:mb-0 pt-2 w-full sm:w-1/2">
            <p class="text-gray-500 flex items-center"><i data-lucide="info" class="w-4 h-4 mr-2"></i> Ready to initiate scan.</p>
          </div>
          <div class="flex space-x-3 w-full sm:w-auto justify-end">
            <button id="startBtn" type="submit" class="inline-flex items-center px-6 py-3 border border-transparent text-sm font-bold rounded-lg shadow-lg text-white bg-teal-600 hover:bg-teal-700 focus:outline-none focus:ring-4 focus:ring-teal-300 transition duration-150 w-full sm:w-auto">
              <i data-lucide="zap" class="w-5 h-5 mr-2"></i> Start Scan
            </button>
            <button id="cancelBtn" type="button" class="inline-flex items-center px-4 py-3 border border-red-300 text-sm font-medium rounded-lg text-red-700 bg-red-50 hover:bg-red-100 disabled:opacity-50 transition duration-150" disabled>
              <i data-lucide="x" class="w-5 h-5 mr-2"></i> Cancel
            </button>
          </div>
        </div>

      </form>
    </div>

    <!-- 2. Recent Scans Table -->
    <div class="bg-white p-6 card-design mb-8">
      <div class="flex justify-between items-center mb-6 border-b pb-3">
        <h2 class="text-2xl font-semibold text-gray-800 flex items-center">
            <i data-lucide="scroll-text" class="w-5 h-5 mr-3 text-gray-500"></i> Recent Scans
        </h2>
        <button id="refreshBtn" class="flex items-center text-sm font-medium text-gray-500 hover:text-teal-600 transition">
            <i data-lucide="rotate-cw" class="w-4 h-4 mr-1"></i> Refresh
        </button>
      </div>

      <!-- Scrollable Wrapper Added Here -->
      <div class="overflow-x-auto overflow-y-auto max-h-[25rem] border border-gray-200 rounded-lg">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50 sticky top-0 z-10 shadow-sm">
            <tr>
              <th class="px-3 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider w-1/12">ID</th>
              <th class="px-3 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider w-4/12">Target</th>
              <th class="px-3 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider w-1/12">Mode</th>
              <th class="px-3 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider w-1/12">Status</th>
              <th class="px-3 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider w-1/12">Progress</th>
              <th class="px-3 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider w-1/12">Verdict</th>
              <th class="px-3 py-3 text-right text-xs font-bold text-gray-600 uppercase tracking-wider w-2/12">Actions</th>
            </tr>
          </thead>
          <tbody id="scansBody" class="bg-white divide-y divide-gray-100">
            <tr><td colspan="7" class="px-3 py-4 text-sm text-gray-500 text-center">Loading scans...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- 3. Results Card -->
    <div class="bg-white p-6 card-design">
      <h2 class="text-2xl font-semibold text-gray-800 mb-6 border-b pb-3 flex items-center">
        <i data-lucide="eye" class="w-5 h-5 mr-3 text-teal-600"></i> Detailed Scan Results
      </h2>
      <div id="resultsArea" class="mt-3 overflow-x-auto">
          <p class="text-gray-500 p-4 bg-gray-50 rounded-lg flex items-center"><i data-lucide="arrow-up-left" class="w-4 h-4 mr-2"></i> Select a scan from the table above to load its detailed findings.</p>
      </div>
    </div>

  </div>

<script>
// Initialize Lucide Icons
lucide.createIcons();

/* Helper: Show form error message */
function showFormError(message) {
    const msgDiv = document.getElementById('jobMessage');
    msgDiv.innerHTML = `<div class="p-2 bg-red-100 text-red-700 rounded-lg flex items-center"><i data-lucide="alert-triangle" class="w-4 h-4 mr-2"></i> ${message}</div>`;
    lucide.createIcons(); // Recreate icons for the message div
}

/* Helper: fetch JSON or throw text error */
async function fetchJSON(url, opts){
  const r = await fetch(url, opts);
  if (!r.ok) {
    const txt = await r.text();
    throw new Error(txt || r.statusText);
  }
  return r.json();
}

/* UI state */
let currentScan = null;

/* Wire buttons */
document.getElementById('refreshBtn').addEventListener('click', loadScans);
document.getElementById('cancelBtn').addEventListener('click', cancelScan);

/* Start scan */
document.getElementById('startBtn').addEventListener('click', async (e) => {
  e.preventDefault();
  const target = document.getElementById('target').value.trim();
  
  // Input Validation - Replaced alert() with showFormError()
  if (!target) { showFormError('Target URL is required.'); return; }

  // Multi-select mode logic
  const modes = [];
  document.querySelectorAll('#modesContainer input[type="checkbox"]:checked').forEach(cb => {
    modes.push(cb.value);
  });
  
  if (modes.length === 0) {
    showFormError('Select at least one Fuzzing Mode.');
    return;
  }

  // Clear previous form errors
  document.getElementById('jobMessage').innerHTML = `<p class="text-gray-500 flex items-center"><i data-lucide="info" class="w-4 h-4 mr-2"></i> Submitting scan request...</p>`;
  lucide.createIcons();
  
  // optional files
  let custom_wordlist = null;
  let custom_payloads = null;
  const wf = document.getElementById('wordlistFile');
  if (wf.files && wf.files.length) {
    const txt = await wf.files[0].text();
    custom_wordlist = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  }
  const pf = document.getElementById('payloadFile');
  if (pf.files && pf.files.length) {
    const txt = await pf.files[0].text();
    custom_payloads = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  }

  const paramsRaw = document.getElementById('paramsInput').value.trim();
  const params = paramsRaw ? paramsRaw.split(',').map(s=>s.trim()).filter(Boolean) : null;

  const payload = {
    target: target,
    modes: modes,            // Now sends an array of selected modes
    custom_wordlist: custom_wordlist,
    custom_payloads: custom_payloads,
    params: params
  };

  try {
    const r = await fetch('/start', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const j = await r.json();
    if (j.scan_id) {
      currentScan = j.scan_id;
      document.getElementById('jobMessage').innerHTML = `<div class="p-2 bg-green-100 text-green-700 rounded-lg flex items-center"><i data-lucide="check-circle" class="w-4 h-4 mr-2"></i> Scan started: <strong>#${j.scan_id}</strong></div>`;
      document.getElementById('cancelBtn').disabled = false;
      pollStatus(currentScan);
      loadScans();
    } else {
      document.getElementById('jobMessage').innerHTML = `<div class="p-2 bg-red-100 text-red-700 rounded-lg flex items-center"><i data-lucide="x-circle" class="w-4 h-4 mr-2"></i> Failed to start scan.</div>`;
    }
    lucide.createIcons();
  } catch (err) {
    console.error(err);
    document.getElementById('jobMessage').innerHTML = `<div class="p-2 bg-red-100 text-red-700 rounded-lg flex items-center"><i data-lucide="alert-triangle" class="w-4 h-4 mr-2"></i> Error: ${err.message}</div>`;
    lucide.createIcons();
  }
});

/* Load recent scans */
async function loadScans(){
  try {
    const j = await fetchJSON('/scans_json');
    const body = document.getElementById('scansBody');
    body.innerHTML = '';
    if (!j.scans || j.scans.length === 0) {
      body.innerHTML = '<tr><td colspan="7" class="px-3 py-4 text-sm text-gray-500 text-center">No scans yet. Start one above!</td></tr>';
      return;
    }
    for (const s of j.scans) {
      const tr = document.createElement('tr');

      // Highlight row if it is the current scan
      if (currentScan === s.id) {
          tr.classList.add('bg-teal-50', 'border-l-4', 'border-teal-500');
      }

      // mode label (since stored as array)
      const modeLabel = Array.isArray(s.modes) ? (s.modes.join(', ')) : s.modes;

      // verdict badge
      let badgeClass = 'verdict-pending';
      let verdictText = 'Pending';
      if (s.verdict === 'SAFE') { badgeClass = 'verdict-safe'; verdictText = 'SAFE'; }
      if (s.verdict === 'NOT SAFE') { badgeClass = 'verdict-not'; verdictText = 'NOT SAFE'; }
      let verdictHtml = `<span class="inline-block px-3 py-1 text-xs font-bold rounded-full ${badgeClass}">${verdictText}</span>`;
      
      // Progress Bar HTML
      const progressValue = s.progress || 0;
      let progressClass = 'bg-gray-400';
      if (s.status === 'running') progressClass = 'bg-teal-500 animate-pulse';
      if (s.status === 'finished' && s.verdict === 'SAFE') progressClass = 'bg-status-safe';
      if (s.status === 'finished' && s.verdict === 'NOT SAFE') progressClass = 'bg-status-not-safe';
      if (s.status === 'cancelled') progressClass = 'bg-status-warning';

      const progressHtml = `
        <div class="h-2 w-full bg-gray-200 rounded-full">
          <div class="h-2 rounded-full ${progressClass} transition-all duration-500" style="width: ${progressValue}%"></div>
          <span class="text-xs text-gray-600 mt-1 block">${progressValue}%</span>
        </div>
      `;


      tr.innerHTML = `
        <td class="px-3 py-3 text-sm font-bold text-gray-900">${s.id}</td>
        <td class="px-3 py-3 text-sm text-gray-700 monospace">${escapeHtml(s.target)}</td>
        <td class="px-3 py-3 text-sm text-gray-700">${escapeHtml(modeLabel)}</td>
        <td class="px-3 py-3 text-sm text-gray-700 capitalize">${escapeHtml(s.status)}</td>
        <td class="px-3 py-3 text-sm text-gray-500">${progressHtml}</td>
        <td class="px-3 py-3 text-sm">${verdictHtml}</td>
        <td class="px-3 py-3 text-right text-sm font-medium flex items-center justify-end space-x-2">
          <button title="View Results" class="text-teal-600 hover:text-teal-800 transition p-1 rounded-full hover:bg-teal-100" onclick="viewResults(${s.id})">
            <i data-lucide="eye" class="w-5 h-5"></i>
          </button>
          <button title="Cancel Scan" class="text-red-500 hover:text-red-700 transition p-1 rounded-full hover:bg-red-100" onclick="sendCancel(${s.id})">
            <i data-lucide="circle-slash" class="w-5 h-5"></i>
          </button>
          <a title="Download CSV" class="text-green-600 hover:text-green-800 transition p-1 rounded-full hover:bg-green-100" href="/download/${s.id}">
            <i data-lucide="download" class="w-5 h-5"></i>
          </a>
        </td>`;
      body.appendChild(tr);
      // Re-create icons after inserting new HTML
      lucide.createIcons();
    }
  } catch (err) {
    console.error(err);
    document.getElementById('jobMessage').innerHTML = `<div class="p-2 bg-red-100 text-red-700 rounded-lg flex items-center"><i data-lucide="alert-triangle" class="w-4 h-4 mr-2"></i> Error: Could not load scans</div>`;
    lucide.createIcons();
  }
}

/* View results and render table */
async function viewResults(id){
  currentScan = id;
  // Highlight the selected row in the table
  document.querySelectorAll('#scansBody tr').forEach(row => row.classList.remove('bg-teal-50', 'border-l-4', 'border-teal-500'));
  document.querySelectorAll(`#scansBody tr`).forEach(row => {
      // Crude way to check ID based on first cell content. In a real app, use a data attribute.
      if (row.querySelector('td')?.textContent.trim() == id) {
          row.classList.add('bg-teal-50', 'border-l-4', 'border-teal-500');
      }
  });

  try {
    document.getElementById('resultsArea').innerHTML = '<p class="text-gray-500 p-4 bg-gray-50 rounded-lg animate-pulse flex items-center"><i data-lucide="loader-circle" class="w-4 h-4 mr-2 animate-spin"></i> Loading results for scan #'+id+'...</p>';
    lucide.createIcons();
    const j = await fetchJSON('/results/' + id);
    renderResults(j.results || []);
  } catch (err) {
    console.error(err);
    document.getElementById('resultsArea').innerHTML = `<p class="text-red-600 p-4 bg-red-50 rounded-lg flex items-center"><i data-lucide="alert-triangle" class="w-4 h-4 mr-2"></i> Failed to load results for scan #${id}.</p>`;
    lucide.createIcons();
  }
}

/* Render results table */
function renderResults(results){
  const area = document.getElementById('resultsArea');
  if (!results || results.length === 0) {
    area.innerHTML = '<p class="text-gray-500 p-4 bg-gray-50 rounded-lg flex items-center"><i data-lucide="file-check-2" class="w-4 h-4 mr-2"></i> No security findings recorded for this scan.</p>';
    lucide.createIcons();
    return;
  }

  let html = `<div class="overflow-x-auto border border-gray-200 rounded-lg"><table class="min-w-full divide-y divide-gray-200">
    <thead class="bg-gray-50"><tr>
    <th class="px-3 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Type</th>
    <th class="px-3 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">URL/Host</th>
    <th class="px-3 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Param</th>
    <th class="px-3 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Payload</th>
    <th class="px-3 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Status</th>
    <th class="px-3 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Reason</th>
    <th class="px-3 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Flags</th>
  </tr></thead><tbody class="bg-white divide-y divide-gray-100">`;

  for (const r of results) {
    const flags = (r.flags || []).map(f => `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">${escapeHtml(f)}</span>`).join(' ');
    const statusLbl = r.status_code !== null && r.status_code !== undefined ? r.status_code : escapeHtml(r.reason || '');
    
    let cls = 'status-other';
    let statusText = String(statusLbl);

    if (typeof r.status_code === 'number') {
      if (r.status_code >= 200 && r.status_code < 300) cls = 'status-200';
      else if (r.status_code === 403) cls = 'status-403';
      else cls = 'status-other';
    } else {
        // For DNS/network errors where status_code is null
        statusText = 'NETWORK';
        cls = 'status-other';
    }

    html += `<tr>
      <td class="px-3 py-3 text-sm font-medium text-gray-900 capitalize">${escapeHtml(r.rtype||'')}</td>
      <td class="px-3 py-3 text-sm text-gray-700 monospace">${escapeHtml(r.url||'')}</td>
      <td class="px-3 py-3 text-sm text-gray-700 monospace">${escapeHtml(r.param||'')}</td>
      <td class="px-3 py-3 text-sm text-gray-700 monospace">${escapeHtml(r.payload||'')}</td>
      <td class="px-3 py-3 text-sm ${cls}">${statusText}</td>
      <td class="px-3 py-3 text-sm text-gray-500">${escapeHtml(r.reason||'')}</td>
      <td class="px-3 py-3 text-sm space-x-1">${flags}</td>
    </tr>`;
  }

  html += '</tbody></table></div>';
  area.innerHTML = html;
}

/* Poll scan status */
async function pollStatus(scanId){
  try {
    const j = await fetchJSON('/status/' + scanId);
    let badgeClass = 'verdict-pending';
    let verdictText = 'Pending';
    if (j.verdict === 'SAFE') { badgeClass = 'verdict-safe'; verdictText = 'SAFE'; }
    if (j.verdict === 'NOT SAFE') { badgeClass = 'verdict-not'; verdictText = 'NOT SAFE'; }

    let badge = `<span class="px-3 py-1 text-xs font-bold rounded-full ${badgeClass}">${verdictText}</span>`;
    
    // Update the main job message
    document.getElementById('jobMessage').innerHTML = `<div class="p-2 bg-teal-100 text-teal-800 rounded-lg flex items-center justify-between"><div class="flex items-center"><i data-lucide="activity" class="w-4 h-4 mr-2"></i> Scan ${scanId} status: <strong>${escapeHtml(j.status).toUpperCase()}</strong> (${j.progress || 0}%)</div> <div>Verdict: ${badge}</div></div>`;
    lucide.createIcons();

    if (j.status === 'finished' || j.status === 'cancelled' || (j.status||'').startsWith('error')) {
      document.getElementById('cancelBtn').disabled = true;
      viewResults(scanId);
      loadScans();
    } else {
      setTimeout(()=>pollStatus(scanId), 1500);
    }
  } catch (err) {
    console.error(err);
    // do not spam UI — use a consistent error message
    // Note: showFormError uses red background, this uses red text only if not a critical error
    const msgDiv = document.getElementById('jobMessage');
    if (!msgDiv.innerHTML.includes('bg-red-100')) {
        msgDiv.innerHTML = `<div class="p-2 text-red-600 flex items-center"><i data-lucide="alert-circle" class="w-4 h-4 mr-2"></i> Status check failed (Network Error).</div>`;
        lucide.createIcons();
    }
  }
}

/* Cancel functions */
async function sendCancel(id){
  try {
    await fetch('/cancel/' + id, { method: 'POST' });
    loadScans();
    if (currentScan === id) {
      document.getElementById('jobMessage').innerHTML = '<div class="p-2 bg-yellow-100 text-yellow-800 rounded-lg flex items-center"><i data-lucide="stop-circle" class="w-4 h-4 mr-2"></i> Scan Cancelled. Results may be incomplete.</div>';
      document.getElementById('cancelBtn').disabled = true;
      lucide.createIcons();
    }
  } catch (err) {
    console.error(err);
    document.getElementById('jobMessage').innerHTML = '<div class="p-2 bg-red-100 text-red-700 rounded-lg flex items-center"><i data-lucide="alert-triangle" class="w-4 h-4 mr-2"></i> Failed to send cancel request.</div>';
    lucide.createIcons();
  }
}

function cancelScan(){
  if (!currentScan) return;
  sendCancel(currentScan);
}

/* Safe escape helper */
function escapeHtml(s){
  if (!s && s !== 0) return '';
  return String(s)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;');
}

/* Initial load */
loadScans();
// Poll for updates every 5 seconds for the recent scans table
setInterval(loadScans, 5000); 
</script>
</body>
</html>
